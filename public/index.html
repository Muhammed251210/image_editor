<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>FotoÄŸraf DÃ¼zenleyici - DÃ¼zgÃ¼n Lens Modu</title>
    <style>
        body { font-family: Arial, sans-serif; background: #f6f6f6; text-align: center; margin: 0; }
        #container { position: relative; display: inline-block; margin: 30px 0; background: #fff; box-shadow: 0 0 12px #ccc; }
        img { display: block; object-fit: contain; }
        #filteredContainer { position: absolute; top: 0; left: 0; height: 100%; overflow: hidden; pointer-events: none; }
        #filteredImg { position: absolute; top: 0; left: 0; }
        #handle { position: absolute; top: 0; width: 7px; height: 100%; background: #29a1f1; border-radius: 4px; cursor: ew-resize; z-index: 2; transition: background 0.2s; }
        #handle:hover { background: #1972ac; }
        #lens { position: absolute; border: 2px solid #29a1f1; border-radius: 50%; width: 150px; height: 150px; overflow: hidden; display: none; z-index: 3; pointer-events: none; background: rgba(255,255,255,0.05); }
        #lensImg { 
            position: absolute; 
            top: 0; 
            left: 0;
            width: 100%; 
            height: 100%;
            object-fit: contain;
        }
        #controls { margin-top: 20px; }
        .filter-group { display: flex; justify-content: center; flex-wrap: wrap; gap: 24px; margin-bottom: 16px; }
        .filter-item { display: flex; flex-direction: column; align-items: center; }
        label { margin-bottom: 3px; font-weight: 500; }
        input[type="range"] { width: 120px; }
        input[type="file"] { margin-right: 10px; }
        button { margin: 0 4px; padding: 7px 14px; background: #29a1f1; border: none; color: #fff; border-radius: 5px; cursor: pointer; font-size: 1em; transition: background .2s; }
        button:hover { background: #1972ac; }
        @media(max-width:700px){
            #container{max-width:100vw;}
            .filter-group{flex-direction:column;align-items:center;}
            /* AI Chatbot Stilleri */
        #aiChatContainer {
            margin: 40px auto 30px;
            width: 80%;
            max-width: 600px;
            border: 1px solid #ccc;
            border-radius: 8px;
            padding: 15px;
            background: #fff;
            text-align: left;
        }
        #chatOutput {
            height: 150px;
            overflow-y: auto;
            border: 1px solid #eee;
            padding: 10px;
            margin-bottom: 10px;
            background: #f9f9f9;
            border-radius: 4px;
        }
        #chatInputContainer {
            display: flex;
            gap: 10px;
        }
        #aiPrompt {
            flex-grow: 1;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .message {
            margin-bottom: 5px;
            padding: 5px 8px;
            border-radius: 5px;
        }
        .user-msg {
            background: #e1f5fe;
            text-align: right;
        }
        .ai-msg {
            background: #f1f8e9;
            text-align: left;
        }
        }
    </style>
</head>
<body>
    <h2>FotoÄŸraf DÃ¼zenleyici</h2>
    
    <div id="controls">
        <input type="file" id="upload" accept="image/*">
        <button id="modeBtn">Lens Modu</button>
        <button id="reset">SÄ±fÄ±rla</button>
        <button id="save">Kaydet</button>
    </div>
    <div id="container" style="width:480px; height:300px;">
        <img id="originalImg" src="https://dummyimage.com/480x300/cccccc/464646.png&text=Resim+yÃ¼kle" style="width:100%;height:100%;object-fit:contain;">
        <div id="filteredContainer" style="width:50%;height:100%;">
            <img id="filteredImg" src="https://dummyimage.com/480x300/cccccc/464646.png&text=Resim+yÃ¼kle" style="width:100%;height:100%;object-fit:contain;">
        </div>
        <div id="handle" style="left:50%;"></div>
        <div id="lens" style="left:0;top:0;">
            <img id="lensImg" src="https://dummyimage.com/480x300/cccccc/464646.png&text=Resim+yÃ¼kle">
        </div>
    </div>
<div id="aiChatContainer">
        <h3>ðŸ¤– YZ GÃ¶rÃ¼ntÃ¼ DÃ¼zenleme Sohbeti</h3>
        <p>LÃ¼tfen maskelenen alana (gÃ¶rÃ¼nÃ¼r filtreli alan) ne eklemek/deÄŸiÅŸtirmek istediÄŸinizi yazÄ±n.</p>
        <div id="chatOutput">
            <div class="message ai-msg">Merhaba! LÃ¼tfen ne yapacaÄŸÄ±mÄ± sÃ¶yleyin (Ã¶rnek: "Arka plana bir aÄŸaÃ§ ekle" veya "KapÄ±yÄ± kÄ±rmÄ±zÄ±ya boya").</div>
        </div>
        <div id="chatInputContainer">
            <input type="text" id="aiPrompt" placeholder="Buraya yazÄ±n...">
            <button id="sendPromptBtn">GÃ¶nder</button>
        </div>
        <div id="aiResultContainer" style="margin-top: 15px; text-align: center;">
            <img id="aiResultImg" style="max-width: 100%; display: none; border: 1px solid #ddd; border-radius: 4px;">
            <button id="saveAiResultBtn" style="display:none; margin-top: 10px;">Yeni Resmi Kaydet</button>
        </div>
    </div>
    
    <div class="filter-group">
        <!-- Filtre sliders here ... -->
        <div class="filter-item">
            <label for="contrast">Kontrast</label>
            <input type="range" id="contrast" min="0" max="200" value="100">
        </div>
        <div class="filter-item">
            <label for="brightness">ParlaklÄ±k</label>
            <input type="range" id="brightness" min="0" max="200" value="100">
        </div>
        <div class="filter-item">
            <label for="saturate">Doygunluk</label>
            <input type="range" id="saturate" min="0" max="200" value="100">
        </div>
        <div class="filter-item">
            <label for="hue">Renk</label>
            <input type="range" id="hue" min="0" max="360" value="0">
        </div>
        <div class="filter-item">
            <label for="sepia">Sepya</label>
            <input type="range" id="sepia" min="0" max="100" value="0">
        </div>
        <div class="filter-item">
            <label for="blur">BulanÄ±k</label>
            <input type="range" id="blur" min="0" max="10" value="0" step="0.2">
        </div>
    </div>
    
    <script>
    // --- Filtreler ve deÄŸiÅŸkenler ---
    const filters = {
        contrast: document.getElementById('contrast'),
        brightness: document.getElementById('brightness'),
        saturate: document.getElementById('saturate'),
        hue: document.getElementById('hue'),
        sepia: document.getElementById('sepia'),
        blur: document.getElementById('blur'),
    };
    const defaultValues = {
        contrast: 100,
        brightness: 100,
        saturate: 100,
        hue: 0,
        sepia: 0,
        blur: 0,
    };

    const upload = document.getElementById('upload');
    const container = document.getElementById('container');
    const originalImg = document.getElementById('originalImg');
    const filteredImg = document.getElementById('filteredImg');
    const filteredContainer = document.getElementById('filteredContainer');
    const handle = document.getElementById('handle');
    const lens = document.getElementById('lens');
    const lensImg = document.getElementById('lensImg');
    const modeBtn = document.getElementById('modeBtn');

    let lensMode = false;

    function applyFilters(){
        const filterStr = 
            `contrast(${filters.contrast.value}%)
            brightness(${filters.brightness.value}%)
            saturate(${filters.saturate.value}%)
            hue-rotate(${filters.hue.value}deg)
            sepia(${filters.sepia.value}%)
            blur(${filters.blur.value}px)
        `.replace(/\s+/g, ' ');
        filteredImg.style.filter = filterStr;
        lensImg.style.filter = filterStr;
    }
    Object.values(filters).forEach(el => el.addEventListener("input", applyFilters));

    // Ã‡ubuk ve mouse hareketleri:
    let isDragging = false;
    function moveHandle(clientX) {
        const rect = container.getBoundingClientRect();
        const offsetX = Math.min(Math.max(clientX - rect.left, 0), rect.width);
        handle.style.left = `${offsetX}px`;
        filteredContainer.style.width = `${offsetX}px`;
    }
    handle.addEventListener('mousedown', () => isDragging = true);
    document.addEventListener('mouseup', () => isDragging = false);
    document.addEventListener('mousemove', e => { if (isDragging) moveHandle(e.clientX); });
    handle.addEventListener('touchstart', e => { isDragging = true; e.preventDefault(); });
    window.addEventListener('touchend', () => isDragging = false);
    window.addEventListener('touchmove', e => { if (isDragging) moveHandle(e.touches[0].clientX); });

    // Resim yÃ¼klenince hem filtreli hem lens img boyutunu gÃ¼ncelle:
    function updateLensImageSize() {
        // boyutu lens'de %100 -- object-fit ile yetiyor
        lensImg.style.width = "100%";
        lensImg.style.height = "100%";
    }
    upload.addEventListener('change', e => {
        const file = e.target.files[0];
        if (!file) return;
        const url = URL.createObjectURL(file);
        originalImg.src = url;
        filteredImg.src = url;
        lensImg.src = url;
        originalImg.onload = () => {
            const renderedWidth = originalImg.offsetWidth;
            const renderedHeight = originalImg.offsetHeight;
            filteredImg.style.width = renderedWidth + 'px';
            filteredImg.style.height = renderedHeight + 'px';
            updateLensImageSize();
            applyFilters();
            handle.style.left = '50%';
            filteredContainer.style.width = '50%';
        };
    });

    // SÄ±fÄ±rlama:
    document.getElementById('reset').addEventListener('click', () => {
        Object.keys(filters).forEach(key => { filters[key].value = defaultValues[key]; });
        applyFilters();
        handle.style.left = '50%';
        filteredContainer.style.width = '50%';
        updateLensImageSize();
    });

    // Mod deÄŸiÅŸtirme (lens/Ã§ubuk)
    modeBtn.addEventListener('click', () => {
        lensMode = !lensMode;
        if (lensMode) {
            lens.style.display = 'block';
            handle.style.display = 'none';
            filteredContainer.style.opacity = '0';
            modeBtn.textContent = 'Ã‡ubuk Modu';
            updateLensImageSize();
        } else {
            lens.style.display = 'none';
            handle.style.display = 'block';
            filteredContainer.style.opacity = '1';
            filteredContainer.style.width = '50%';
            modeBtn.textContent = 'Lens Modu';
        }
    });

    // Lens'in doÄŸru koordinatÄ±yla pozisyonunu ayarla:
    function moveLens(clientX, clientY) {
        const rect = container.getBoundingClientRect();
        const lensSize = lens.offsetWidth;
        let x = clientX - rect.left - lensSize / 2;
        let y = clientY - rect.top - lensSize / 2;
        x = Math.max(0, Math.min(x, rect.width - lensSize));
        y = Math.max(0, Math.min(y, rect.height - lensSize));
        lens.style.left = `${x}px`;
        lens.style.top = `${y}px`;
        // DÃœZELTME: lens iÃ§indeki img'yi lens pozisyonuna gÃ¶re -x, -y ile kaydÄ±r
        lensImg.style.left = `${-x}px`;
        lensImg.style.top = `${-y}px`;
        // img boyutlarÄ± lens boyutu ile aynÄ±/veya %100
    }
    container.addEventListener('mousemove', e => { if (lensMode) moveLens(e.clientX, e.clientY); });
    container.addEventListener('touchmove', e => {
        if (lensMode && e.touches.length > 0) {
            e.preventDefault();
            moveLens(e.touches[0].clientX, e.touches[0].clientY);
        }
    });

    // Kaydet butonu:
    document.getElementById('save').addEventListener('click', () => {
        if (!originalImg.src || originalImg.src.startsWith('data:image/svg')) {
            console.error("LÃ¼tfen Ã¶nce bir resim yÃ¼kleyin.");
            return;
        }
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = originalImg.naturalWidth;
        canvas.height = originalImg.naturalHeight;
        const filterStr = `
            contrast(${filters.contrast.value}%)
            brightness(${filters.brightness.value}%)
            saturate(${filters.saturate.value}%)
            hue-rotate(${filters.hue.value}deg)
            sepia(${filters.sepia.value}%)
            blur(${filters.blur.value}px)
        `.replace(/\s+/g, ' ');
        ctx.filter = filterStr;
        ctx.drawImage(originalImg, 0, 0, canvas.width, canvas.height);
        const dataURL = canvas.toDataURL("image/jpeg", 0.9);
        const a = document.createElement('a');
        a.href = dataURL;
        a.download = 'duzenlenmis_resim.jpg';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        console.log("DÃ¼zenlenmiÅŸ resim kaydedildi.");
    });

    applyFilters();
        // --- YZ Chatbot ve DÃ¼zenleme Ä°ÅŸlevi ---

    const aiPromptInput = document.getElementById('aiPrompt');
    const sendPromptBtn = document.getElementById('sendPromptBtn');
    const chatOutput = document.getElementById('chatOutput');
    const aiResultImg = document.getElementById('aiResultImg');
    const saveAiResultBtn = document.getElementById('saveAiResultBtn');
    
    // NOT: API anahtarÄ±nÄ± artÄ±k HTML iÃ§inde TUTMUYORUZ. Sunucu tarafÄ± endpoint kullanacaÄŸÄ±z.
    // const OPENAI_API_KEY = 'sk???'; // <<< KALDIRILDI

    function addMessage(message, type) {
        const msgDiv = document.createElement('div');
        msgDiv.className = `message ${type}-msg`;
        msgDiv.textContent = message;
        chatOutput.appendChild(msgDiv);
        chatOutput.scrollTop = chatOutput.scrollHeight;
    }

    // Canvas'tan PNG Maskesi OluÅŸturma Ä°ÅŸlevi
    function createMaskFromHandle() {
        const rect = container.getBoundingClientRect();
        const maskWidth = filteredContainer.offsetWidth; // Filtreli alanÄ±n geniÅŸliÄŸi
        
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        
        // Canvas boyutlarÄ±nÄ± orijinal resim boyutuna gÃ¶re ayarlayÄ±n
        canvas.width = originalImg.naturalWidth;
        canvas.height = originalImg.naturalHeight;
        
        // 1. TÃ¼m alanÄ± beyaz yap (deÄŸiÅŸtirilmeyecek alan)
        ctx.fillStyle = 'white';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        // 2. DeÄŸiÅŸtirilecek maske alanÄ±nÄ± ÅžEFFAF (transparent) yapÄ±n
        // VarsayÄ±mÄ±: Filtreli alan (sol taraf) deÄŸiÅŸtirilecek alandÄ±r.
        
        // Hesaplama: Rendered (gÃ¶rÃ¼nen) geniÅŸlikteki oranÄ±n doÄŸal geniÅŸliÄŸe aktarÄ±lmasÄ±
        const proportion = maskWidth / rect.width;
        const naturalMaskWidth = canvas.width * proportion;
        
        ctx.clearRect(0, 0, naturalMaskWidth, canvas.height);
        
        // 3. PNG verisini dÃ¶ndÃ¼r
        return new Promise((resolve) => {
            canvas.toBlob((blob) => {
                resolve(blob);
            }, 'image/png');
        });
    }

    // YardÄ±mcÄ±: Blob -> base64 (dataURL'den base64 kÄ±smÄ±nÄ± dÃ¶ndÃ¼rÃ¼r)
    function blobToBase64NoPrefix(blob) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onloadend = () => {
                const result = reader.result;
                // result: data:image/png;base64,AAAA...
                const parts = result.split(',');
                resolve(parts[1]);
            };
            reader.onerror = reject;
            reader.readAsDataURL(blob);
        });
    }

    // YardÄ±mcÄ±: Orijinal resmi fetch ile blob alÄ±p base64'e Ã§evir
    async function imageUrlToBase64NoPrefix(url) {
        // EÄŸer src zaten data URL ise doÄŸrudan prefix'i kaldÄ±r
        if (url.startsWith('data:')) {
            return url.split(',')[1];
        }
        const resp = await fetch(url);
        const blob = await resp.blob();
        return await blobToBase64NoPrefix(blob);
    }

    // Ana DÃ¼zenleme Ä°ÅŸlevi (SUNUCUYA GÃ–NDERÄ°R â€” HTML iÃ§inde API KEY YOK)
    async function sendImageEditRequest(prompt) {
        if (!originalImg.src || originalImg.src.includes('dummyimage')) {
            addMessage("LÃ¼tfen Ã¶nce bir resim yÃ¼kleyin.", "ai");
            return;
        }

        addMessage("Ä°steÄŸiniz iÅŸleniyor...", "ai");
        sendPromptBtn.disabled = true;

        try {
            // 1. Orijinal resmi base64 al
            const originalBase64 = await imageUrlToBase64NoPrefix(originalImg.src);

            // 2. Maske Blob'unu Canvas'tan oluÅŸtur ve base64e Ã§evir
            const maskBlob = await createMaskFromHandle();
            const maskBase64 = await blobToBase64NoPrefix(maskBlob);

            // 3. Sunucuya JSON ile gÃ¶nder
            const response = await fetch('/api/edit-image', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    prompt,
                    imageBase64: originalBase64,
                    maskBase64: maskBase64,
                    size: '512x512'
                })
            });

            const data = await response.json();

            // OpenAI'den gelen farklÄ± ÅŸekillerde olabilir: b64_json veya url
            if (response.ok) {
                // 1) EÄŸer b64_json varsa kullan
                try {
                    const b64 = data.data?.[0]?.b64_json;
                    if (b64) {
                        aiResultImg.src = "data:image/png;base64," + b64;
                        aiResultImg.style.display = 'block';
                        saveAiResultBtn.style.display = 'block';
                        addMessage("DÃ¼zenleme tamamlandÄ±. Yeni resim aÅŸaÄŸÄ±dadÄ±r.", "ai");
                        return;
                    }
                } catch (e) { /* yoksa diÄŸer yola bak */ }

                // 2) EÄŸer url varsa kullan (Ã¶r. eski DALLÂ·E response)
                const url = data.data?.[0]?.url || data.url;
                if (url) {
                    aiResultImg.src = url;
                    aiResultImg.style.display = 'block';
                    saveAiResultBtn.style.display = 'block';
                    addMessage("DÃ¼zenleme tamamlandÄ±. Yeni resim aÅŸaÄŸÄ±dadÄ±r.", "ai");
                    return;
                }

                // 3) Direkt base64 dÃ¶ndÃ¼rÃ¼lmÃ¼ÅŸ olabilir (data.image)
                const alt = data.image || data.result;
                if (alt) {
                    aiResultImg.src = alt.startsWith('data:') ? alt : ("data:image/png;base64," + alt);
                    aiResultImg.style.display = 'block';
                    saveAiResultBtn.style.display = 'block';
                    addMessage("DÃ¼zenleme tamamlandÄ±. Yeni resim aÅŸaÄŸÄ±dadÄ±r.", "ai");
                    return;
                }

                addMessage("API'den beklenmeyen sonuÃ§ dÃ¶ndÃ¼. Konsolu kontrol et.", "ai");
                console.error('API response:', data);
            } else {
                const errMsg = data.error?.message || JSON.stringify(data);
                addMessage(`Hata: ${errMsg}`, "ai");
            }

        } catch (error) {
            addMessage(`Beklenmedik bir hata oluÅŸtu: ${error.message}`, "ai");
            console.error(error);
        } finally {
            sendPromptBtn.disabled = false;
        }
    }

    sendPromptBtn.addEventListener('click', () => {
        const prompt = aiPromptInput.value.trim();
        if (prompt) {
            addMessage(prompt, "user");
            sendImageEditRequest(prompt);
            aiPromptInput.value = '';
        }
    });

    aiPromptInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            sendPromptBtn.click();
        }
    });

    // Yeni AI sonucunu kaydetme iÅŸlevi
    saveAiResultBtn.addEventListener('click', () => {
        if (aiResultImg.src) {
            const a = document.createElement('a');
            a.href = aiResultImg.src;
            a.download = 'ai_duzenlenmis_resim.png';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }
    });
    </script>
</body>
</html>
