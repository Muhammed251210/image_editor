import React, { useState, useEffect, useRef } from 'react';

// Sabitler
// Codespaces URL'sini veya Render URL'sini buraya ekleyin.
// Önerilen: Render URL'nizi kullanın: "https://ai-image-editor-api.onrender.com/edit"
const API_BASE_URL = "https://ai-image-editor-api.onrender.com"; 
const API_EDIT_ENDPOINT = `${API_BASE_URL}/edit`; // Resim düzenleme endpoint'i

// Simülasyon için varsayılan bir başlangıç resmi
const INITIAL_IMAGE_URL = "https://placehold.co/800x600/1E3A8A/ffffff?text=Yuklenecek+Resim";

// Image Comparison Slider Component'i
const ImageCompareSlider = ({ originalSrc, modifiedSrc }) => {
    const [sliderPos, setSliderPos] = useState(50);
    const containerRef = useRef(null);

    const handleMouseMove = (e) => {
        if (e.buttons === 1 || e.type === 'touchmove') {
            const container = containerRef.current;
            if (!container) return;

            const rect = container.getBoundingClientRect();
            let clientX = e.clientX;

            if (e.type === 'touchmove') {
                clientX = e.touches[0].clientX;
            }

            const newPos = Math.max(0, Math.min(100, ((clientX - rect.left) / rect.width) * 100));
            setSliderPos(newPos);
        }
    };

    return (
        <div 
            ref={containerRef}
            className="relative w-full h-[400px] md:h-[600px] overflow-hidden rounded-xl shadow-2xl cursor-ew-resize select-none"
            onMouseMove={handleMouseMove}
            onTouchMove={handleMouseMove}
            onMouseDown={(e) => e.preventDefault()}
            onTouchStart={(e) => e.preventDefault()}
        >
            {/* Orijinal Resim (Tümü) */}
            <img 
                src={originalSrc} 
                alt="Orijinal Resim" 
                className="absolute inset-0 w-full h-full object-cover" 
                draggable="false"
            />

            {/* Düzenlenmiş Resim (Kırpılmış) */}
            <div 
                className="absolute inset-0 overflow-hidden" 
                style={{ width: `${sliderPos}%` }}
            >
                <img 
                    src={modifiedSrc} 
                    alt="Düzenlenmiş Resim" 
                    className="absolute inset-0 w-full h-full object-cover" 
                    style={{ transform: `translateX(-${100 - sliderPos}%)` }}
                    draggable="false"
                />
            </div>

            {/* Kaydırma Çubuğu */}
            <div 
                className="absolute top-0 bottom-0 w-1 bg-white/50 cursor-ew-resize group transition-all" 
                style={{ left: `calc(${sliderPos}% - 0.5px)` }}
                draggable="false"
            >
                <div className="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-8 h-8 rounded-full bg-white shadow-xl flex items-center justify-center border-2 border-gray-900 group-hover:w-10 group-hover:h-10 transition-all duration-150">
                    <svg className="w-4 h-4 text-gray-800" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="3" d="M8 7h8m-8 7h8M12 4v16"></path></svg>
                </div>
            </div>
        </div>
    );
};

// Chatbot'un mesajlarını yöneten yardımcı fonksiyon
const handleChatResponse = (prompt) => {
    // Bu, Gemini'nin sohbet komutunu (halı sarı olsun) alıp
    // AI resim düzenleme modeline uygun bir komuta çevirdiği yerdir.
    
    // Simülasyon için: Eğer kullanıcı 'sarı' kelimesini kullanırsa, 
    // AI komutunu 'color_change_yellow_carpet' olarak varsayalım.
    if (prompt.toLowerCase().includes('sarı')) {
        return {
            filter: 'color_change', // Yeni filtre tipi
            prompt: prompt,
            edit_command: 'change the color of the carpet to yellow' // AI için gerçek komut
        };
    }
    // Simülasyon için: Eğer kullanıcı 'parlak' kelimesini kullanırsa,
    if (prompt.toLowerCase().includes('parlak')) {
        return {
            filter: 'auto_enhance', 
            prompt: prompt,
            edit_command: 'increase brightness and contrast'
        };
    }
    
    // Varsayılan olarak sadece 'auto_enhance' (otomatik iyileştirme) filtresini kullan
    return {
        filter: 'auto_enhance',
        prompt: prompt,
        edit_command: 'generic automatic enhancement'
    };
};


export default function App() {
    const [originalImage, setOriginalImage] = useState(INITIAL_IMAGE_URL);
    const [modifiedImage, setModifiedImage] = useState(INITIAL_IMAGE_URL);
    const [chatMessages, setChatMessages] = useState([]);
    const [inputPrompt, setInputPrompt] = useState("");
    const [isLoading, setIsLoading] = useState(false);

    // Mesaj kutusunun otomatik aşağı kaymasını sağlar
    const messagesEndRef = useRef(null);
    useEffect(() => {
        messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
    }, [chatMessages]);

    // Resim Yükleme Simülasyonu
    const handleImageUpload = (e) => {
        // Normalde burada File API ile resim yüklenir ve base64'e dönüştürülür.
        // Biz simülasyon için yeni bir resim URL'si ile değiştiriyoruz.
        const newUrl = `https://picsum.photos/800/600?r=${Date.now()}`;
        setOriginalImage(newUrl);
        setModifiedImage(newUrl);
        setChatMessages([{ type: 'system', text: 'Yeni resim yüklendi. Komutlarınızı bekliyorum.' }]);
    };

    // Resim düzenleme API çağrısı
    const callImageEditAPI = async (commandDetails) => {
        setIsLoading(true);

        try {
            const response = await fetch(API_EDIT_ENDPOINT, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    image_url: originalImage, // Orijinal resmi gönderiyoruz
                    filter: commandDetails.filter, // Örneğin: 'color_change'
                    prompt: commandDetails.edit_command // Örneğin: 'change the color of the carpet to yellow'
                }),
            });

            const data = await response.json();

            if (response.ok) {
                // Başarılı olursa, düzenlenmiş resmi güncelliyoruz (Simülasyon)
                const newModifiedUrl = `https://placehold.co/800x600/3B82F6/ffffff?text=DUZENLENDI:+${commandDetails.filter}`;
                setModifiedImage(newModifiedUrl);
                
                // Sistemin başarılı yanıtı
                setChatMessages(prev => [...prev, { 
                    type: 'system', 
                    text: `Resminizi başarıyla düzenledim: ${data.message} Yeni halınızın sarı rengini karşılaştırma çubuğunda görebilirsiniz!`
                }]);
            } else {
                // API Hatası
                setChatMessages(prev => [...prev, { 
                    type: 'system', 
                    text: `Hata: API isteği başarısız oldu (${response.status}): ${data.message}` 
                }]);
            }
        } catch (error) {
             // Bağlantı Hatası (Render uyku modu)
            setChatMessages(prev => [...prev, { 
                type: 'system', 
                text: `Bağlantı Hatası: Lütfen Codespaces'in çalıştığından veya Render'ın uyku modundan uyanması için 10 saniye bekleyip tekrar deneyin.` 
            }]);
            console.error("API Hata:", error);
        } finally {
            setIsLoading(false);
        }
    };

    // Chatbot mesajı gönderme
    const handleSendPrompt = (e) => {
        e.preventDefault();
        const prompt = inputPrompt.trim();
        if (!prompt) return;

        // 1. Kullanıcı mesajını ekle
        setChatMessages(prev => [...prev, { type: 'user', text: prompt }]);
        setInputPrompt("");

        // 2. Chatbot/Gemini komutunu işle (Simülasyon)
        const commandDetails = handleChatResponse(prompt);

        // 3. API'yi çağır
        callImageEditAPI(commandDetails);
    };


    return (
        <div className="min-h-screen bg-gray-900 text-white p-4 md:p-8 font-sans">
            <header className="text-center mb-8">
                <h1 className="text-4xl font-extrabold text-blue-400">AI Sohbet Editörü</h1>
                <p className="text-gray-400 mt-2">Metin komutlarınızla resimlerinizi anında düzenleyin.</p>
            </header>

            <div className="max-w-6xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-8">
                
                {/* Sol Kısım: Resim Görüntüleyici ve Karşılaştırma */}
                <div className="lg:col-span-2 space-y-4">
                    <div className="bg-gray-800 p-4 rounded-xl shadow-inner">
                        <label 
                            htmlFor="file-upload" 
                            className="w-full inline-flex items-center justify-center p-3 border-2 border-dashed border-blue-600 rounded-lg text-blue-300 hover:bg-gray-700 cursor-pointer transition-colors"
                        >
                            <svg className="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                            Yeni Resim Yükle (Simülasyon)
                        </label>
                        <input id="file-upload" type="file" className="hidden" onChange={handleImageUpload} />
                    </div>
                    
                    <ImageCompareSlider 
                        originalSrc={originalImage} 
                        modifiedSrc={modifiedImage}
                    />

                </div>

                {/* Sağ Kısım: Chatbot Arayüzü */}
                <div className="lg:col-span-1 flex flex-col h-[500px] md:h-[700px] bg-gray-800 rounded-xl shadow-2xl p-4">
                    <h2 className="text-xl font-bold mb-3 text-blue-300 border-b border-gray-700 pb-2">AI Düzenleme Sohbeti</h2>
                    
                    {/* Mesaj Kutusu */}
                    <div className="flex-grow overflow-y-auto space-y-4 pr-2 custom-scrollbar" style={{ scrollbarWidth: 'thin' }}>
                        {chatMessages.map((msg, index) => (
                            <div key={index} className={`flex ${msg.type === 'user' ? 'justify-end' : 'justify-start'}`}>
                                <div className={`max-w-[80%] p-3 rounded-xl shadow-md ${
                                    msg.type === 'user' ? 'bg-blue-600 text-white rounded-br-none' : 'bg-gray-700 text-gray-200 rounded-tl-none'
                                }`}>
                                    <p className="font-medium">{msg.text}</p>
                                </div>
                            </div>
                        ))}
                        {isLoading && (
                             <div className="flex justify-start">
                                <div className="max-w-[80%] p-3 rounded-xl shadow-md bg-gray-700 text-gray-200 rounded-tl-none">
                                    <div className="flex items-center space-x-2">
                                        <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-blue-400"></div>
                                        <p className="font-medium text-sm">AI düzenliyor...</p>
                                    </div>
                                </div>
                            </div>
                        )}
                        <div ref={messagesEndRef} />
                    </div>

                    {/* Giriş Alanı */}
                    <form onSubmit={handleSendPrompt} className="mt-4 flex space-x-3">
                        <input 
                            type="text" 
                            value={inputPrompt}
                            onChange={(e) => setInputPrompt(e.target.value)}
                            placeholder="Örn: 'Halı sarı olsun' veya 'Daha parlak yap'"
                            className="flex-grow p-3 rounded-lg border border-gray-700 bg-gray-900 text-white focus:ring-2 focus:ring-blue-500 outline-none"
                            disabled={isLoading}
                        />
                        <button 
                            type="submit" 
                            className="bg-blue-600 hover:bg-blue-700 text-white p-3 rounded-lg font-bold transition-colors disabled:bg-gray-600"
                            disabled={isLoading || !inputPrompt.trim()}
                        >
                            Gönder
                        </button>
                    </form>
                </div>
            </div>

            {/* Tailwind CSS için özel kaydırma çubuğu stili (React'ta inline stil zor olduğu için burada ekledim) */}
            <style jsx global>{`
                /* Basit kaydırma çubuğu stilini simüle etme */
                .custom-scrollbar::-webkit-scrollbar {
                    width: 6px;
                }
                .custom-scrollbar::-webkit-scrollbar-thumb {
                    background-color: #4B5563; /* gray-600 */
                    border-radius: 3px;
                }
                .custom-scrollbar::-webkit-scrollbar-track {
                    background: #1F2937; /* gray-800 */
                }
            `}<l/stye>
        </div>
    );
}
