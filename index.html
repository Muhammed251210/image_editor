<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ultra Fotoƒüraf D√ºzenleyici</title>
<style>
/* --- TEMEL STƒ∞LLER --- */
:root {
    --bg-color: #f0f2f5;
    --panel-bg: #ffffff;
    --text-color: #333;
    --primary: #4f46e5;
    --primary-hover: #4338ca;
    --accent: #ec4899;
    --border-color: #e5e7eb;
}
body.dark-mode {
    --bg-color: #111827;
    --panel-bg: #1f2937;
    --text-color: #f3f4f6;
    --primary: #6366f1;
    --primary-hover: #818cf8;
    --border-color: #374151;
}

body { font-family: 'Inter', 'Segoe UI', Arial, sans-serif; background:var(--bg-color); color:var(--text-color); text-align:center; margin:0; transition: background 0.3s, color 0.3s; }
h2 { margin-top: 15px; font-weight: 800; letter-spacing: -0.5px; }

/* --- ANA KONTEYNER --- */
#container { 
    position: relative; 
    display: inline-block; 
    margin:20px 0; 
    background:var(--panel-bg); 
    box-shadow:0 10px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04); 
    max-width:95vw; 
    box-sizing: border-box;
    border: 0px solid transparent; 
    transition: border 0.2s;
    overflow: hidden; 
    border-radius: 8px;
    touch-action: none;
    user-select: none;
}
#container.dragover { border: 3px dashed var(--primary); background: rgba(79, 70, 229, 0.1); }

/* Orijinal resim (Alt katman) */
#container > img#originalImg { 
    display: block; width:100%; height:100%; object-fit:contain; pointer-events: none; 
}

/* --- KATMANLAR --- */
/* Filtreli Alan */
#filteredContainer { 
    position:absolute; top:0; left:0; height:100%; width: 50%; 
    overflow:hidden; pointer-events:none; z-index: 10; 
    border-right: 1px solid rgba(255,255,255,0.5);
    background: var(--panel-bg); 
    transition: width 0.1s ease-out;
}
body.lens-active #filteredContainer { width: 100% !important; border-right: none !important; }
body.lens-active #handle { display: none !important; }

#filteredImg { position:absolute; top:0; left:0; object-fit:contain; }

#vignetteOverlay, #tintOverlay, #noiseOverlay { 
    position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
    pointer-events: none; z-index: 12; 
}
#vignetteOverlay { transition: box-shadow 0.1s linear; }
#tintOverlay { mix-blend-mode: overlay; z-index: 13; }
#noiseOverlay { z-index: 14; opacity: 0; background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='1'/%3E%3C/svg%3E"); }

/* √áizim Canvasƒ± */
#drawingCanvas {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    z-index: 18; pointer-events: none;
}

/* --- SLIDER HANDLE --- */
#handle { 
    position:absolute; top:0; left: 50%; width:40px; height:100%; 
    margin-left: -20px; 
    background: transparent; 
    cursor:ew-resize; z-index:20; 
    display: flex; justify-content: center; 
}
#handle::before {
    content: ''; display: block; width: 4px; height: 100%; background: #fff;
    box-shadow: 0 0 10px rgba(0,0,0,0.5);
}
#handle::after { 
    content:'‚Üî'; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 12px;
    position:absolute; top:50%; left:50%; width:32px; height:32px; 
    background:var(--primary); border-radius:50%; 
    transform:translate(-50%, -50%); 
    z-index:21; box-shadow: 0 4px 6px rgba(0,0,0,0.3);
}
#handle:hover::before { background: #eee; }
#handle:hover::after { background:var(--accent); }

/* --- LENS MODU --- */
#lens { 
    position:absolute; 
    border: 3px solid var(--primary); 
    border-radius:50%; 
    width:160px; height:160px; 
    overflow:hidden; display:none; 
    z-index: 50; 
    pointer-events: none; 
    background:rgba(255,255,255,0.1); 
    box-shadow: 0 10px 25px rgba(0,0,0,0.5), inset 0 0 20px rgba(0,0,0,0.2); 
    /* D√úZELTME: Boyut hesabƒ±nƒ± sabitlemek i√ßin */
    box-sizing: border-box;
}
#lensImg { position:absolute; object-fit:contain; }
#lensOverlayContainer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }

/* --- UI --- */
#controls { margin:20px auto; display:flex; flex-wrap:wrap; justify-content:center; gap:12px; max-width: 900px; }
button, input[type=file], select { padding:10px 18px; border:none; border-radius:8px; cursor:pointer; font-size:0.9rem; outline:none; font-weight: 600; }
button { background:var(--primary); color:#fff; transition:all .2s; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
button:hover { background:var(--primary-hover); transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
button.secondary { background: #6b7280; }
button.secondary:hover { background: #4b5563; }
button.danger { background: #ef4444; }
button.danger:hover { background: #dc2626; }
button.active { background: var(--accent); } 

.tab-container { max-width: 900px; margin: 0 auto 25px auto; background: var(--panel-bg); border-radius: 12px; padding: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); }
.tabs { display: flex; border-bottom: 2px solid var(--border-color); margin-bottom: 20px; overflow-x: auto; gap: 5px; padding-bottom: 5px; }
.tab-btn { background: transparent; color: var(--text-color); border-radius: 8px 8px 0 0; padding: 12px 24px; box-shadow: none; opacity: 0.6; font-weight: 600; border-bottom: 3px solid transparent; }
.tab-btn:hover { background: rgba(0,0,0,0.03); opacity: 0.9; transform: none; }
.tab-btn.active { border-bottom: 3px solid var(--primary); color: var(--primary); opacity: 1; background: rgba(79, 70, 229, 0.05); }
.tab-content { display: none; animation: fadeIn 0.3s; }
.tab-content.active { display: block; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

.control-panel { display: flex; flex-wrap: wrap; gap: 15px; justify-content: center; align-items: center; }
.filter-grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap:20px; padding: 10px; }
.filter-item { display:flex; flex-direction:column; align-items:center; background: var(--bg-color); padding: 15px; border-radius: 10px; transition: transform 0.2s; }
.filter-item:hover { transform: scale(1.02); }
label { margin-bottom:8px; font-size: 0.85em; font-weight:700; color: var(--text-color); letter-spacing: 0.5px; }
input[type=range] { width:100%; accent-color: var(--primary); cursor: pointer; height: 6px; border-radius: 5px; }

#overlayLayer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 15; overflow: hidden; pointer-events: none; }
.draggable-item { position: absolute; cursor: grab; user-select: none; pointer-events: auto; border: 1px dashed transparent; transition: border 0.2s; }
.draggable-item:hover, .draggable-item.active { border: 1px dashed #fff; background: rgba(0,0,0,0.2); box-shadow: 0 0 10px rgba(0,0,0,0.3); }
.draggable-item img { max-width: 150px; pointer-events: none; }

#cropContainer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 30; display: none; touch-action: none; }
#cropBox { position: absolute; box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.7); border: 1px solid rgba(255,255,255,0.8); cursor: move; }
.crop-handle { position: absolute; width: 14px; height: 14px; background: var(--primary); border: 2px solid #fff; border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.3); }
.handle-nw { top: -7px; left: -7px; cursor: nwse-resize; }
.handle-ne { top: -7px; right: -7px; cursor: nesw-resize; }
.handle-sw { bottom: -7px; left: -7px; cursor: nesw-resize; }
.handle-se { bottom: -7px; right: -7px; cursor: nwse-resize; }

.header-bar { display: flex; justify-content: space-between; align-items: center; padding: 10px 20px; max-width: 900px; margin: 0 auto; }
.theme-toggle { background: transparent; color: var(--text-color); font-size: 1.5em; padding: 5px; box-shadow: none; }
input[type=color] { -webkit-appearance: none; border: none; width: 35px; height: 35px; padding: 0; border-radius: 50%; cursor: pointer; }
input[type=color]::-webkit-color-swatch { border: 2px solid rgba(0,0,0,0.1); border-radius: 50%; }

body.drawing-mode #container { cursor: crosshair; }
body.drawing-mode #handle { pointer-events: none; opacity: 0.5; }
body.lens-active #container { cursor: none; }

.svg-filters { position: absolute; width: 0; height: 0; overflow: hidden; }
@media(max-width:700px){ .filter-grid { grid-template-columns: 1fr 1fr; } .tabs { font-size: 0.8em; } }
</style>
</head>
<body id="appBody">

<svg class="svg-filters">
  <filter id="duotoneFilter">
    <feColorMatrix type="matrix" values=".33 .33 .33 0 0 .33 .33 .33 0 0 .33 .33 .33 0 0 0 0 0 1 0" result="grayscale" />
    <feComponentTransfer color-interpolation-filters="sRGB" result="duotone">
        <feFuncR type="table" tableValues="0 1" id="duotoneR"/>
        <feFuncG type="table" tableValues="0 1" id="duotoneG"/>
        <feFuncB type="table" tableValues="0 1" id="duotoneB"/>
        <feFuncA type="table" tableValues="0 1"/>
    </feComponentTransfer>
  </filter>
</svg>

<div class="header-bar">
    <h2>‚ú® Ultra Fotoƒüraf Edit√∂r√º</h2>
    <button id="themeBtn" class="theme-toggle" title="Karanlƒ±k Mod">üåì</button>
</div>

<div id="controls">
    <input type="file" id="upload" accept="image/*" style="background:var(--panel-bg); color:var(--text-color);">
    <button id="save">üíæ ƒ∞ndir (HD)</button>
    <button id="reset" class="secondary">üîÑ Sƒ±fƒ±rla</button>
</div>

<div class="tab-container">
    <div class="tabs">
        <button class="tab-btn active" onclick="openTab('tab-filters')">üéõÔ∏è Filtreler</button>
        <button class="tab-btn" onclick="openTab('tab-draw')">üé® √áizim</button>
        <button class="tab-btn" onclick="openTab('tab-objects')">üñºÔ∏è Katmanlar</button>
        <button class="tab-btn" onclick="openTab('tab-adjust')">‚úÇÔ∏è Ara√ßlar</button>
    </div>

    <div id="tab-filters" class="tab-content active">
        <div class="filter-grid">
             <div class="filter-item"><label>Kontrast</label><input type="range" id="contrast" min="0" max="200" value="100"></div>
             <div class="filter-item"><label>Parlaklƒ±k</label><input type="range" id="brightness" min="0" max="200" value="100"></div>
             <div class="filter-item"><label>Doygunluk</label><input type="range"id="saturate" min="0" max="200" value="100"></div>
             <div class="filter-item"><label>Bulanƒ±klƒ±k</label><input type="range" id="blur" min="0" max="10" value="0" step="0.2"></div>
             <div class="filter-item"><label>Pikselle≈ütir</label><input type="range" id="pixelate" min="1" max="20" value="1" step="1" title="Sans√ºr efekti"></div>
             <div class="filter-item"><label>G√ºr√ºlt√º (Grain)</label><input type="range" id="noise" min="0" max="100" value="0"></div>
             <div class="filter-item" style="grid-column: span 2; align-items: flex-start;">
                <label style="width:100%; display:flex; justify-content:space-between;"><span>Duotone Efekti</span><input type="checkbox" id="duotoneToggle"></label>
                <div style="display:flex; gap:10px; width:100%; margin-top:5px;">
                    <input type="color" id="duotoneC1" value="#2e1065" title="Koyu Renk">
                    <input type="color" id="duotoneC2" value="#f472b6" title="A√ßƒ±k Renk">
                </div>
             </div>
        </div>
    </div>

    <div id="tab-draw" class="tab-content">
        <div class="control-panel">
            <button id="drawToggle" class="secondary">‚úèÔ∏è √áizimi Ba≈ülat</button>
            <input type="color" id="brushColor" value="#ff0000">
            <input type="range" id="brushSize" min="1" max="50" value="5" style="width:100px" title="Fƒ±r√ßa Boyutu">
            <button id="eraserBtn" class="secondary" title="Silgi Modu">üßΩ</button>
            <button id="clearDrawBtn" class="danger">üóëÔ∏è Temizle</button>
        </div>
        <p style="text-align:center; font-size:0.85em; color:#666; margin-top:10px;">Not: √áizim modundayken kar≈üƒ±la≈ütƒ±rma √ßubuƒüu devre dƒ±≈üƒ± kalƒ±r.</p>
    </div>

    <div id="tab-objects" class="tab-content">
        <div class="control-panel" style="align-items: flex-end;">
            <div style="display:flex; flex-direction:column; gap:5px;">
                <label>Metin Ekle</label>
                <div style="display:flex; gap:5px;">
                    <input type="text" id="textInput" placeholder="Yazƒ±..." style="border:1px solid #ccc; width:100px; padding:5px;">
                    <input type="color" id="textColor" value="#ffffff">
                    <button id="addTextBtn">Ekle</button>
                </div>
            </div>
            <div style="width:1px; height:40px; background:#ddd; margin:0 10px;"></div>
            <div style="display:flex; flex-direction:column; gap:5px;">
                <label>Logo/Resim Ekle</label>
                <button onclick="document.getElementById('addImgInput').click()">üìÇ Resim Se√ß</button>
                <input type="file" id="addImgInput" accept="image/*" style="display:none">
            </div>
        </div>
        <hr style="border:0; border-top:1px solid var(--border-color); margin:15px 0;">
        <div style="display:flex; gap:10px; justify-content:center; flex-wrap:wrap;">
            <button class="secondary" onclick="addSticker('üòé')" style="font-size:1.2em; padding:5px 10px;">üòé</button>
            <button class="secondary" onclick="addSticker('üî•')" style="font-size:1.2em; padding:5px 10px;">üî•</button>
            <button class="secondary" onclick="addSticker('‚ù§Ô∏è')" style="font-size:1.2em; padding:5px 10px;">‚ù§Ô∏è</button>
            <button class="secondary" onclick="addSticker('‚ú®')" style="font-size:1.2em; padding:5px 10px;">‚ú®</button>
            <button class="secondary" onclick="addSticker('üìç')" style="font-size:1.2em; padding:5px 10px;">üìç</button>
        </div>
    </div>

    <div id="tab-adjust" class="tab-content">
        <div class="control-panel">
            <button id="modeBtn">üîç Lens Modu</button>
            <button id="cropBtn">‚úÇÔ∏è Kƒ±rp</button>
        </div>
        <div class="crop-controls" style="display:none; margin-top:10px; justify-content:center; gap:10px;">
            <button id="confirmCrop" style="background:#10b981;">‚úÖ Onayla</button>
            <button id="cancelCrop" style="background:#ef4444;">‚ùå ƒ∞ptal</button>
        </div>
        <div class="transform-controls" style="margin-top:15px;">
            <button id="rotateLeft">‚Ü∫</button>
            <button id="rotateRight">‚Üª</button>
            <button id="flipX">‚Üî</button>
            <button id="flipY">‚Üï</button>
        </div>
        <hr style="border:0; border-top:1px solid var(--border-color); margin:15px 0;">
        <div class="filter-grid">
             <div class="filter-item"><label>Vignette</label><input type="range" id="vignette" min="0" max="100" value="0"></div>
             <div class="filter-item"><label>√áer√ßeve</label><input type="range" id="borderWidth" min="0" max="50" value="0"></div>
             <div class="filter-item"><label>Renk Kaplama</label><input type="range" id="tintOpacity" min="0" max="100" value="0"></div>
             <div class="filter-item"><label>√áer√ß. Rengi</label><input type="color" id="borderColor" value="#ffffff"></div>
             <div class="filter-item"><label>Kaplama Rengi</label><input type="color" id="tintColor" value="#ff9900"></div>
        </div>
    </div>
</div>

<div id="container" style="width:480px; height:300px;">
    <!-- Orijinal Resim -->
    <img id="originalImg" src="https://dummyimage.com/800x500/e0e0e0/666666.png&text=Resim+Y√ºkle">
    
    <!-- Filtreli Resim -->
    <div id="filteredContainer">
        <img id="filteredImg" src="https://dummyimage.com/800x500/e0e0e0/666666.png&text=Resim+Y√ºkle">
        <div id="vignetteOverlay"></div>
        <div id="tintOverlay"></div> 
        <div id="noiseOverlay"></div> 
    </div>

    <canvas id="drawingCanvas"></canvas>
    <div id="overlayLayer"></div>
    
    <!-- Handle -->
    <div id="handle"></div>
    
    <!-- Lens -->
    <div id="lens">
        <img id="lensImg" src="https://dummyimage.com/800x500/e0e0e0/666666.png&text=Resim+Y√ºkle">
        <div id="lensOverlayContainer"></div>
    </div>
    
    <div id="cropContainer">
        <div id="cropBox">
            <div class="crop-handle handle-nw"></div>
            <div class="crop-handle handle-ne"></div>
            <div class="crop-handle handle-sw"></div>
            <div class="crop-handle handle-se"></div>
        </div>
    </div>
</div>

<script>
// == DOM ELEMENTS ==
const filters = { contrast: document.getElementById('contrast'), brightness: document.getElementById('brightness'), saturate: document.getElementById('saturate'), blur: document.getElementById('blur'), pixelate: document.getElementById('pixelate'), noise: document.getElementById('noise'), vignette: document.getElementById('vignette') };
const duotoneElements = { toggle: document.getElementById('duotoneToggle'), c1: document.getElementById('duotoneC1'), c2: document.getElementById('duotoneC2'), r: document.getElementById('duotoneR'), g: document.getElementById('duotoneG'), b: document.getElementById('duotoneB') };
const drawingCanvas = document.getElementById('drawingCanvas');
const overlayElements = { addImg: document.getElementById('addImgInput'), tintColor: document.getElementById('tintColor'), tintOp: document.getElementById('tintOpacity'), borderW: document.getElementById('borderWidth'), borderC: document.getElementById('borderColor'), textIn: document.getElementById('textInput'), textCol: document.getElementById('textColor'), addText: document.getElementById('addTextBtn') };
const core = { container: document.getElementById('container'), original: document.getElementById('originalImg'), filtered: document.getElementById('filteredImg'), fContainer: document.getElementById('filteredContainer'), handle: document.getElementById('handle'), lens: document.getElementById('lens'), lensImg: document.getElementById('lensImg'), lensOver: document.getElementById('lensOverlayContainer'), modeBtn: document.getElementById('modeBtn'), overlayLayer: document.getElementById('overlayLayer'), noise: document.getElementById('noiseOverlay') };

// State
let state = {
    filters: { contrast: 100, brightness: 100, saturate: 100, blur: 0, pixelate: 1, noise: 0, vignette: 0 },
    transform: { rotate: 0, scaleX: 1, scaleY: 1 },
    crop: { x: 0, y: 0, w: 100, h: 100, isApplied: false },
    border: { width: 0, color: '#ffffff' },
    tint: { color: '#ff9900', opacity: 0 },
    duotone: { active: false, c1: '#2e1065', c2: '#f472b6' }
};

let lensMode = false; 
let isDrawingMode = false;
let isDrawing = false;
let isEraser = false;
let drawCtx = drawingCanvas.getContext('2d');

// == INIT & RESIZE ==
function updateImageDimensions() {
    const w = core.container.offsetWidth;
    const h = core.container.offsetHeight;
    core.filtered.style.width = w + 'px';
    core.filtered.style.height = h + 'px';
    if(core.lensImg) { core.lensImg.style.width = w + 'px'; core.lensImg.style.height = h + 'px'; }
    if(drawingCanvas.width !== w || drawingCanvas.height !== h) {
        const tempCanvas = document.createElement('canvas');
        tempCanvas.width = drawingCanvas.width; tempCanvas.height = drawingCanvas.height;
        tempCanvas.getContext('2d').drawImage(drawingCanvas, 0, 0);
        drawingCanvas.width = w; drawingCanvas.height = h;
        drawCtx.drawImage(tempCanvas, 0, 0, w, h);
        setupBrush();
    }
    core.lensOver.style.width = w + 'px'; core.lensOver.style.height = h + 'px';
}
window.addEventListener('resize', updateImageDimensions);

function handleFile(file) {
    if (!file || !file.type.startsWith('image/')) return;
    const url = URL.createObjectURL(file);
    core.original.src = url; core.filtered.src = url; core.lensImg.src = url;
    core.original.onload = () => {
        let w = core.original.naturalWidth; let h = core.original.naturalHeight;
        const maxW = window.innerWidth * 0.9; const maxH = window.innerHeight * 0.6;
        const ratio = w / h;
        let newW = Math.min(w, maxW); let newH = newW / ratio;
        if(newH > maxH) { newH = maxH; newW = newH * ratio; }
        core.container.style.width = newW + 'px'; core.container.style.height = newH + 'px';
        setTimeout(() => {
             updateImageDimensions();
             drawCtx.clearRect(0, 0, drawingCanvas.width, drawingCanvas.height);
             core.overlayLayer.innerHTML = ''; core.lensOver.innerHTML = ''; 
             resetAll();
        }, 50);
    };
}
document.getElementById('upload').addEventListener('change', e => handleFile(e.target.files[0]));
window.openTab = function(tabName) {
    document.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(tb => tb.classList.remove('active'));
    document.getElementById(tabName).classList.add('active');
    event.currentTarget.classList.add('active');
}

// == LENS MODU ==
core.modeBtn.addEventListener('click', () => {
    lensMode = !lensMode;
    document.body.classList.toggle('lens-active', lensMode);
    if (lensMode) {
        core.lens.style.display = 'block';
        core.overlayLayer.style.clipPath = 'none';
        drawingCanvas.style.clipPath = 'none';
        core.modeBtn.textContent = 'üìè √áubuk Modu';
        core.modeBtn.classList.add('active');
        updateImageDimensions();
        const rect = core.container.getBoundingClientRect();
        moveLens(rect.left + rect.width/2, rect.top + rect.height/2);
    } else {
        core.lens.style.display = 'none';
        core.fContainer.style.width = '50%';
        core.handle.style.left = '50%';
        const rect = core.container.getBoundingClientRect();
        const x = rect.width / 2;
        core.overlayLayer.style.clipPath = `inset(0 ${rect.width - x}px 0 0)`;
        drawingCanvas.style.clipPath = `inset(0 ${rect.width - x}px 0 0)`;
        core.modeBtn.textContent = 'üîç Lens Modu';
        core.modeBtn.classList.remove('active');
    }
});

function moveLens(clientX, clientY) {
    const rect = core.container.getBoundingClientRect();
    // border-box olduƒüu i√ßin offsetWidth tam kutu geni≈üliƒüini verir (border dahil)
    // Lensin merkezini bulmak i√ßin 2'ye b√∂leriz.
    const lensRadius = core.lens.offsetWidth / 2;
    
    let mouseX = clientX - rect.left;
    let mouseY = clientY - rect.top;

    let lensLeft = mouseX - lensRadius;
    let lensTop = mouseY - lensRadius;
    core.lens.style.left = lensLeft + 'px';
    core.lens.style.top = lensTop + 'px';

    // ƒ∞√ßeriƒüin (0,0) noktasƒ± borderƒ±n i√ßidir (content-box ba≈ülar).
    // Ancak img absolute ve top/left 0 olduƒüu i√ßin padding box'a g√∂re hizalanƒ±r.
    // Border kalƒ±nlƒ±ƒüƒ±nƒ± da (3px) hesaba katarak kaydƒ±rmalƒ±yƒ±z.
    // Lensin "g√∂rsel merkezi" mouse'un olduƒüu yerdir.
    // Mouse, lensin dƒ±≈ü sol kenarƒ±ndan "lensRadius" kadar i√ßeridedir.
    // ƒ∞√ßerik alanƒ± ise dƒ±≈ü sol kenardan "borderWidth" kadar i√ßeridedir.
    // Yani i√ßerik alanƒ± i√ßindeki g√∂rsel merkez: lensRadius - borderWidth
    // (80px - 3px = 77px)
    // Resim √ºzerindeki mouseX noktasƒ±nƒ±n, i√ßerik alanƒ±ndaki 77. pikselde durmasƒ± gerekir.
    // L + mouseX = 77 => L = 77 - mouseX.
    
    // CSS'den border width alalƒ±m (dinamik)
    const style = window.getComputedStyle(core.lens);
    const borderLeft = parseFloat(style.borderLeftWidth) || 0;
    const borderTop = parseFloat(style.borderTopWidth) || 0;
    
    const centerOffsetX = lensRadius - borderLeft;
    const centerOffsetY = lensRadius - borderTop;

    const innerLeft = centerOffsetX - mouseX;
    const innerTop = centerOffsetY - mouseY;

    core.lensImg.style.left = innerLeft + 'px';
    core.lensImg.style.top = innerTop + 'px';
    core.lensOver.style.left = innerLeft + 'px';
    core.lensOver.style.top = innerTop + 'px';
}

core.container.addEventListener('mousemove', e => { if (lensMode) moveLens(e.clientX, e.clientY); });
core.container.addEventListener('touchmove', e => { if (lensMode && e.touches.length > 0) { e.preventDefault(); moveLens(e.touches[0].clientX, e.touches[0].clientY); } }, { passive: false });

// == Fƒ∞LTERS ==
function applyFilters() {
    let filterStr = `contrast(${state.filters.contrast}%) brightness(${state.filters.brightness}%) saturate(${state.filters.saturate}%) blur(${state.filters.blur}px) `;
    if(state.duotone.active) { filterStr += `url(#duotoneFilter) `; updateDuotoneMatrix(); } else { filterStr += `grayscale(0%) `; }
    core.filtered.style.filter = filterStr;
    if(core.lensImg) core.lensImg.style.filter = filterStr; 
    if(core.noise) core.noise.style.opacity = state.filters.noise / 200;
    if(document.getElementById('vignetteOverlay')) { const val = state.filters.vignette; const spread = (val / 100) * 150; document.getElementById('vignetteOverlay').style.boxShadow = `inset 0 0 ${spread}px ${spread/2}px rgba(0,0,0,${val/100})`; }
    if(document.getElementById('tintOverlay')) { document.getElementById('tintOverlay').style.backgroundColor = state.tint.color; document.getElementById('tintOverlay').style.opacity = state.tint.opacity / 100; }
    core.container.style.border = `${state.border.width}px solid ${state.border.color}`;
}
function hexToRgb(hex) { const r = parseInt(hex.substr(1,2), 16)/255; const g = parseInt(hex.substr(3,2), 16)/255; const b = parseInt(hex.substr(5,2), 16)/255; return {r,g,b}; }
function updateDuotoneMatrix() { const c1 = hexToRgb(state.duotone.c1); const c2 = hexToRgb(state.duotone.c2); duotoneElements.r.setAttribute('tableValues', `${c1.r} ${c2.r}`); duotoneElements.g.setAttribute('tableValues', `${c1.g} ${c2.g}`); duotoneElements.b.setAttribute('tableValues', `${c1.b} ${c2.b}`); }
Object.keys(state.filters).forEach(k => { if(filters[k]) filters[k].addEventListener('input', e => { state.filters[k] = parseFloat(e.target.value); applyFilters(); }); });
duotoneElements.toggle.addEventListener('change', e => { state.duotone.active = e.target.checked; applyFilters(); });
overlayElements.tintOp.addEventListener('input', e => { state.tint.opacity = e.target.value; applyFilters(); });
overlayElements.borderW.addEventListener('input', e => { state.border.width = e.target.value; applyFilters(); });

// == DRAWING ==
function setupBrush() { drawCtx.lineCap = 'round'; drawCtx.lineJoin = 'round'; updateBrush(); }
function updateBrush() { drawCtx.lineWidth = document.getElementById('brushSize').value; drawCtx.strokeStyle = isEraser ? 'rgba(0,0,0,1)' : document.getElementById('brushColor').value; drawCtx.globalCompositeOperation = isEraser ? 'destination-out' : 'source-over'; }
document.getElementById('drawToggle').addEventListener('click', () => { isDrawingMode = !isDrawingMode; document.body.classList.toggle('drawing-mode', isDrawingMode); drawingCanvas.style.pointerEvents = isDrawingMode ? 'auto' : 'none'; document.getElementById('drawToggle').textContent = isDrawingMode ? 'üõë √áizimi Durdur' : '‚úèÔ∏è √áizimi Ba≈ülat'; document.getElementById('drawToggle').style.background = isDrawingMode ? '#ef4444' : '#6b7280'; });
document.getElementById('brushColor').addEventListener('input', () => { isEraser = false; updateBrush(); });
document.getElementById('eraserBtn').addEventListener('click', () => { isEraser = !isEraser; updateBrush(); });
document.getElementById('clearDrawBtn').addEventListener('click', () => drawCtx.clearRect(0, 0, drawingCanvas.width, drawingCanvas.height));
drawingCanvas.addEventListener('mousedown', e => { if(!isDrawingMode) return; isDrawing = true; drawCtx.beginPath(); drawCtx.moveTo(e.offsetX, e.offsetY); });
drawingCanvas.addEventListener('mousemove', e => { if(!isDrawing || !isDrawingMode) return; drawCtx.lineTo(e.offsetX, e.offsetY); drawCtx.stroke(); });
drawingCanvas.addEventListener('mouseup', () => { if(isDrawing) { drawCtx.closePath(); isDrawing = false; } });
drawingCanvas.addEventListener('touchstart', e => { if(!isDrawingMode) return; e.preventDefault(); isDrawing=true; const rect=drawingCanvas.getBoundingClientRect(); drawCtx.beginPath(); drawCtx.moveTo(e.touches[0].clientX-rect.left, e.touches[0].clientY-rect.top); }, {passive:false});
drawingCanvas.addEventListener('touchmove', e => { if(!isDrawing || !isDrawingMode) return; e.preventDefault(); const rect=drawingCanvas.getBoundingClientRect(); drawCtx.lineTo(e.touches[0].clientX-rect.left, e.touches[0].clientY-rect.top); drawCtx.stroke(); }, {passive:false});

// == OVERLAYS ==
function makeDraggable(el) {
    let isDragging = false, startX, startY, initialLeft, initialTop;
    const mouseDown = e => { if(e.target.className.includes('remove-btn')) return; isDragging = true; const evt = e.type === 'touchstart' ? e.touches[0] : e; startX = evt.clientX; startY = evt.clientY; initialLeft = el.offsetLeft; initialTop = el.offsetTop; document.addEventListener('mousemove', mouseMove); document.addEventListener('mouseup', mouseUp); document.addEventListener('touchmove', mouseMove, {passive:false}); document.addEventListener('touchend', mouseUp); };
    const mouseMove = e => { if (!isDragging) return; e.preventDefault(); const evt = e.type === 'touchmove' ? e.touches[0] : e; const dx = evt.clientX - startX; const dy = evt.clientY - startY; const nl = initialLeft + dx; const nt = initialTop + dy; el.style.left = nl+'px'; el.style.top = nt+'px'; if(el._clone) { el._clone.style.left = nl+'px'; el._clone.style.top = nt+'px'; } };
    const mouseUp = () => { isDragging = false; document.removeEventListener('mousemove', mouseMove); document.removeEventListener('mouseup', mouseUp); document.removeEventListener('touchmove', mouseMove); document.removeEventListener('touchend', mouseUp); };
    el.addEventListener('mousedown', mouseDown); el.addEventListener('touchstart', mouseDown, {passive:false});
}
function createOverlayItem(contentNode) {
    const div = document.createElement('div'); div.className = 'draggable-item'; div.style.left = '50%'; div.style.top = '50%'; div.style.transform = 'translate(-50%, -50%)';
    const rm = document.createElement('div'); rm.className = 'remove-btn'; rm.innerHTML = '√ó'; rm.style.cssText = 'position:absolute; top:-10px; right:-10px; width:20px; height:20px; background:red; color:white; border-radius:50%; text-align:center; cursor:pointer; line-height:18px; font-weight:bold; display:none;';
    rm.onclick = () => { if(div._clone) div._clone.remove(); div.remove(); };
    div.appendChild(contentNode.cloneNode(true)); div.appendChild(rm);
    div.addEventListener('mouseenter', () => rm.style.display = 'block'); div.addEventListener('mouseleave', () => rm.style.display = 'none');
    core.overlayLayer.appendChild(div);
    const cloneDiv = document.createElement('div'); cloneDiv.className = 'draggable-item'; cloneDiv.style.left = '50%'; cloneDiv.style.top = '50%'; cloneDiv.style.transform = 'translate(-50%, -50%)'; cloneDiv.style.pointerEvents = 'none'; 
    cloneDiv.appendChild(contentNode.cloneNode(true)); core.lensOver.appendChild(cloneDiv); div._clone = cloneDiv; makeDraggable(div);
}
overlayElements.addText.addEventListener('click', () => { if(!overlayElements.textIn.value) return; const s = document.createElement('span'); s.textContent = overlayElements.textIn.value; s.style.color = overlayElements.textCol.value; s.style.fontSize = '24px'; s.style.fontWeight = 'bold'; s.className = 'draggable-text'; createOverlayItem(s); overlayElements.textIn.value = ''; });
window.addSticker = e => { const s = document.createElement('span'); s.textContent = e; s.style.fontSize = '40px'; s.className = 'draggable-sticker'; createOverlayItem(s); };

// == TRANSFORMS & CROP ==
function applyTransforms() { const t = `rotate(${state.transform.rotate}deg) scale(${state.transform.scaleX}, ${state.transform.scaleY})`; core.original.style.transform = t; core.filtered.style.transform = t; core.lensImg.style.transform = t; }
document.getElementById('rotateRight').onclick = () => { state.transform.rotate += 90; applyTransforms(); };
let draggingHandle = false;
function moveHandle(e) { if(!draggingHandle || isDrawingMode) return; let clientX = e.touches ? e.touches[0].clientX : e.clientX; const rect = core.container.getBoundingClientRect(); let x = Math.max(0, Math.min(clientX - rect.left, rect.width)); core.handle.style.left = x+'px'; core.fContainer.style.width = x+'px'; const insetRight = rect.width - x; core.overlayLayer.style.clipPath = `inset(0 ${insetRight}px 0 0)`; drawingCanvas.style.clipPath = `inset(0 ${insetRight}px 0 0)`; }
core.handle.addEventListener('mousedown', () => draggingHandle=true); core.handle.addEventListener('touchstart', () => draggingHandle=true, {passive:false});
window.addEventListener('mouseup', () => draggingHandle=false); window.addEventListener('touchend', () => draggingHandle=false);
window.addEventListener('mousemove', moveHandle); window.addEventListener('touchmove', moveHandle, {passive:false});

// == SAVE ==
document.getElementById('save').addEventListener('click', () => {
    const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d');
    const w = core.container.offsetWidth; const h = core.container.offsetHeight; canvas.width = w; canvas.height = h;
    ctx.save(); ctx.translate(w/2, h/2); ctx.rotate(state.transform.rotate * Math.PI/180); ctx.scale(state.transform.scaleX, state.transform.scaleY); ctx.drawImage(core.original, -w/2, -h/2, w, h); ctx.restore();
    const fCanvas = document.createElement('canvas'); fCanvas.width = w; fCanvas.height = h; const fCtx = fCanvas.getContext('2d');
    fCtx.filter = core.filtered.style.filter; fCtx.drawImage(canvas, 0, 0);
    if(state.duotone.active) {
        const id = fCtx.getImageData(0,0,w,h); const d = id.data; const c1 = hexToRgb(state.duotone.c1); const c2 = hexToRgb(state.duotone.c2);
        for(let i=0; i<d.length; i+=4) { const gray = (d[i]*0.3 + d[i+1]*0.59 + d[i+2]*0.11)/255; d[i]=(c1.r+(c2.r-c1.r)*gray)*255; d[i+1]=(c1.g+(c2.g-c1.g)*gray)*255; d[i+2]=(c1.b+(c2.b-c1.b)*gray)*255; }
        fCtx.putImageData(id, 0, 0);
    }
    ctx.drawImage(fCanvas, 0, 0); ctx.drawImage(drawingCanvas, 0, 0);
    document.querySelectorAll('.draggable-item').forEach(item => {
        if(item.parentElement === core.lensOver) return;
        const rect = item.getBoundingClientRect(); const cRect = core.container.getBoundingClientRect();
        const x = rect.left - cRect.left; const y = rect.top - cRect.top;
        const img = item.querySelector('img'); const txt = item.querySelector('.draggable-text'); const stkr = item.querySelector('.draggable-sticker');
        ctx.save(); if(img) ctx.drawImage(img, x, y, img.width, img.height); else if(txt||stkr) { ctx.font = txt?"bold 24px Arial":"40px Arial"; ctx.fillStyle = txt?txt.style.color:"black"; ctx.textBaseline='top'; ctx.fillText(item.innerText.replace('√ó',''), x, y); } ctx.restore();
    });
    if(state.border.width > 0) { ctx.strokeStyle = state.border.color; ctx.lineWidth = state.border.width * 2; ctx.strokeRect(0,0,w,h); }
    if(state.tint.opacity > 0) { ctx.globalCompositeOperation = 'overlay'; ctx.fillStyle = state.tint.color; ctx.globalAlpha = state.tint.opacity/100; ctx.fillRect(0,0,w,h); }
    const a = document.createElement('a'); a.href = canvas.toDataURL('image/jpeg', 0.9); a.download = 'edit.jpg'; document.body.appendChild(a); a.click(); document.body.removeChild(a);
});

function resetAll() {
    Object.keys(state.filters).forEach(k => { if(filters[k]) filters[k].value = state.filters[k]; });
    drawCtx.clearRect(0, 0, drawingCanvas.width, drawingCanvas.height);
    applyFilters(); applyTransforms();
    core.overlayLayer.style.clipPath = 'none';
    drawingCanvas.style.clipPath = 'none';
}

document.getElementById('themeBtn').onclick = () => document.body.classList.toggle('dark-mode');
setupBrush(); updateImageDimensions();
</script>
</body>
</html>


